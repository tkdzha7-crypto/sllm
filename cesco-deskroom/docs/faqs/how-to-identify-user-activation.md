# 활성 고객 판별 로직 가이드

> **목표**: 해약 예측 모델에서, 개별 고객이 현재 활성 고객인지, 해약 고객인지 판별하는 로직을 이해합니다.


## 전체 흐름 요약 다이어그램

```
┌─────────────────────────────────────────────────────────────┐
│                    customers_df (입력)                       │
│              고객 목록 + JSON 계약정보                          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 1️⃣ JSON → DataFrame 변환                                     │
│    각 계약을 한 줄씩 펼침                                        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 2️⃣ 데이터 정리                                                 │
│    유효하지 않은 고객코드 제외                                     │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 3️⃣ 다음 계약 시작일 찾기                                         │
│    같은 고객+계약대상의 다음 계약 연결                              │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 4️⃣ 해약일자 최종 결정                                           │
│    없는 해약일을 논리적으로 추론                                   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 5️⃣ 유지일수 계산                                               │
│    시작일 ~ 해지일 사이 일수                                     │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 6️⃣ 계약대상별 집계                                              │
│    서비스별로 활성/해약 판정                                      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 7️⃣ 고객별 최종 상태                                             │
│    하나라도 활성이면 → 활성 고객                                   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 8️⃣ 수정된 활성 로직                                             │
│    3가지 조건으로 더 정확하게 판별                                 │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 9️⃣ 원본과 병합                                                 │
│    최종계약상태 컬럼 추가                                         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                customers_with_status (출력)                  │
│         원본 + 최종계약상태 + 활성계약정보                          │
└─────────────────────────────────────────────────────────────┘
```

---

## 단계별 상세 설명

### 1단계: 데이터 가져오기 (JSON → DataFrame 변환)

**무엇을 하나요?**
- 입력으로 받은 `customers_df`(고객 목록)에서 **계약 정보가 있는 고객만** 골라냅니다.
- 각 고객의 계약 정보는 **JSON 문자열**로 저장되어 있어서, 이를 풀어서 테이블 형태로 변환합니다.

**데이터 변환 예시:**
```
입력 (JSON):
고객코드: "A001"
contracts_info: '[{"계약일자": "2023-01-01", "종료일자": "2024-01-01", ...}, {...}]'

출력 (DataFrame):
| 고객코드 | 계약일자   | 종료일자   | 해약일자 | 해약여부 |
|---------|-----------|-----------|---------|---------|
| A001    | 2023-01-01| 2024-01-01| None    | FALSE   |
| A001    | 2024-01-01| 2025-01-01| None    | FALSE   |
```

---

### 2단계: 데이터 정리

**무엇을 하나요?**
- 유효하지 않은 고객코드를 제외합니다
  - 빈 값, None, 특정 테스트 코드(`AT7728`) 제거

---

### 3단계: 다음 계약 시작일 찾기

**무엇을 하나요?**
- 같은 고객이 같은 계약대상(예: 해충방제, 공기청정 등)에 대해 **여러 번 계약**했을 수 있습니다.
- 시간순으로 정렬해서, **각 계약의 다음 계약 시작일**을 찾습니다.

**왜 필요한가요?**
- 계약이 끝났지만 바로 재계약한 경우, 실제로는 해약이 아님을 판단하기 위해서입니다.

---

### 4단계: 해약일자 최종 결정

**무엇을 하나요?**

복잡한 조건으로 **최종 해약일**을 계산합니다:

1. **해약일자가 이미 있으면** → 그대로 사용
2. **해약일자가 없고, 다음 계약이 있으면** → 다음 계약 시작일을 해약일로
3. **해약일자가 없고, 다음 계약도 없으면** → 현재 계약의 시작일을 해약일로
4. **종료일이 오늘 이전인데 해약일이 없으면** → 종료일을 해약일로

---

### 5단계: 논리적 계약해지일 & 유지일수 계산

**무엇을 하나요?**
- **논리_계약해지일**: 아직 계약이 유효한 경우(미래 종료일) → 분석 수행일을 Temporary Value로 사용
- **유지일수**: 시작일부터 해지일까지 며칠인지 계산

---

### 6단계: 계약대상별 집계

**무엇을 하나요?**
- 한 고객이 여러 계약대상(서비스 종류)을 가질 수 있습니다.
- **고객코드 + 계약대상** 조합별로 묶어서:
  - 총 계약 수
  - 해약된 계약 수
  - 활성/해약 여부 결정

**판정 기준:**
```
계약대상별_해약여부 =
  (총 계약 수 - 해약된 계약 수) > 0 이면 → 활성(0)
  그렇지 않으면 → 해약(1)
```
---

### 7단계: 고객별 최종 상태 결정

**무엇을 하나요?**
- 6단계에서 계산한 계약대상별 상태를 합쳐서, **고객 단위로 최종 판정**

**판정 기준:**
```
최종계약상태 =
  활성 계약대상이 1개라도 있으면 → 활성 고객(1)
  모두 해약이면 → 해약 고객(0)
```

---

### 8단계: 수정된 활성 로직 (최종 판별)

**무엇을 하나요?**

더 정확한 활성 계약 판별을 위해 **3가지 조건을 모두 확인**:

```python
is_active = (
    해약일자가 없음 (None) AND
    해약여부가 'FALSE' AND
    (종료일자가 미래 OR 종료일자가 '99991231' 무기한)
)
```

---

### 9단계: 원본 데이터와 병합

**무엇을 하나요?**
- 계산된 `최종계약상태` 정보를 원본 `customers_df`에 붙입니다.
- 계약 정보가 없는 고객은 자동으로 **해약(0)**으로 처리

---

## 최종 출력

### 반환값: `customers_with_status`

원본 고객 데이터프레임에 다음 컬럼이 추가됩니다:

| 컬럼명 | 설명 |
|-------|------|
| `최종계약상태` | 1: 활성 고객, 0: 해약 고객 |
| `has_active_contract` | True/False - 활성 계약 보유 여부 |
| `unique_targets` | 고객이 보유한 계약대상(서비스) 종류 수 |
| `total_contracts` | 고객의 총 계약 건수 |

---

## 참조 소스코드

### 핵심 파일

| 파일 | 설명 | 핵심 라인 |
|-----|------|---------|
| `flows/analyze_current_user/active_check.py` | 활성 고객 판별 메인 로직 | `fetch_data()` 함수 (30-392줄) |

### 단계별 코드 위치

| 단계 | 설명 | 라인 번호 |
|-----|------|---------|
| 1단계 | JSON → DataFrame 변환 | 36-68줄 |
| 2단계 | 데이터 정리 (유효하지 않은 고객 제외) | 79-84줄 |
| 3단계 | 다음 계약 시작일 찾기 | 92-96줄 |
| 4단계 | 해약일자 최종 결정 | 98-115줄 |
| 5단계 | 논리적 계약해지일 & 유지일수 계산 | 119-128줄 |
| 6단계 | 계약대상별 집계 | 143-167줄 |
| 7단계 | 고객별 최종 상태 결정 | 168-186줄 |
| 8단계 | 수정된 활성 로직 (최종) | 234-276줄 |
| 9단계 | 원본 데이터와 병합 | 290-310줄 |


### 데이터 흐름 참조

```
입력: customers_df
  └─ 필수 컬럼: '고객코드', '고객명', 'contracts_info' (JSON)

중간 데이터:
  └─ contracts_df: JSON을 펼친 계약 테이블
  └─ df_2sort: 해약일자 계산이 완료된 테이블
  └─ customer_activity: 고객별 활성 여부 집계

출력: customers_with_status
  └─ 추가 컬럼: '최종계약상태', 'has_active_contract', 'unique_targets', 'total_contracts'
```

---

## 요약

1. **입력**: 고객 정보 + JSON 형태의 계약 정보
2. **처리**: 9단계에 걸쳐 해약 여부를 논리적으로 판정
3. **출력**: 각 고객이 활성(1) 또는 해약(0)인지 표시된 데이터프레임

핵심 판정 기준:
- **해약일자가 없고**
- **해약여부가 FALSE이고**
- **종료일자가 미래이거나 무기한(99991231)**
- 위 세 가지를 모두 만족하면 **활성 고객**입니다.
